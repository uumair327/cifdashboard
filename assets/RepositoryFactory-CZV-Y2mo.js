var N=Object.defineProperty;var b=(o,e,t)=>e in o?N(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var d=(o,e,t)=>b(o,typeof e!="symbol"?e+"":e,t);import{T as f,e as E,m as y,j as g,l as p,p as w,u as v,n as R,r as $,h as D}from"./firebase-BqgI0o68.js";import{l as s,d as u}from"./index-Dq3omjz3.js";class l extends Error{constructor(t){super(t.message);d(this,"code");d(this,"severity");d(this,"recoverable");d(this,"originalError");d(this,"context");d(this,"timestamp");this.name="DashboardError",this.code=t.code,this.severity=t.severity||"medium",this.recoverable=t.recoverable??!0,this.originalError=t.originalError,this.context=t.context,this.timestamp=new Date,Error.captureStackTrace&&Error.captureStackTrace(this,l)}getUserMessage(){switch(this.code){case"NOT_FOUND":return"The requested item could not be found.";case"PERMISSION_DENIED":return"You do not have permission to perform this action.";case"NETWORK_ERROR":return"A network error occurred. Please check your connection and try again.";case"VALIDATION_ERROR":return this.message;case"TIMEOUT":return"The operation took too long. Please try again.";case"CONFLICT":return"This operation conflicts with existing data.";case"OPERATION_FAILED":return"The operation failed. Please try again.";default:return"An unexpected error occurred. Please try again."}}isRecoverable(){return this.recoverable}toJSON(){return{name:this.name,code:this.code,message:this.message,severity:this.severity,recoverable:this.recoverable,timestamp:this.timestamp.toISOString(),context:this.context,stack:this.stack,originalError:this.originalError?{message:this.originalError.message,stack:this.originalError.stack}:void 0}}}const h={notFound:(o,e)=>new l({code:"NOT_FOUND",message:e?`${o} with ID "${e}" not found`:`${o} not found`,severity:"low",recoverable:!1,context:{resource:o,id:e}}),permissionDenied:(o,e)=>new l({code:"PERMISSION_DENIED",message:`Permission denied: Cannot ${o} ${e}`,severity:"high",recoverable:!1,context:{action:o,resource:e}}),networkError:o=>new l({code:"NETWORK_ERROR",message:"Network request failed",severity:"medium",recoverable:!0,originalError:o}),validationError:(o,e)=>new l({code:"VALIDATION_ERROR",message:`Validation failed for ${o}: ${e}`,severity:"low",recoverable:!0,context:{field:o,reason:e}}),operationFailed:(o,e)=>new l({code:"OPERATION_FAILED",message:`Operation "${o}" failed`,severity:"medium",recoverable:!0,originalError:e,context:{operation:o}}),timeout:(o,e)=>new l({code:"TIMEOUT",message:`Operation "${o}" timed out after ${e}ms`,severity:"medium",recoverable:!0,context:{operation:o,timeoutMs:e}}),conflict:(o,e)=>new l({code:"CONFLICT",message:`Conflict with ${o}: ${e}`,severity:"medium",recoverable:!0,context:{resource:o,reason:e}})};class T{constructor(e){d(this,"collectionName");this.collectionName=e}docToEntity(e,t){var r,i;return{...t,id:e,createdAt:((r=t.createdAt)==null?void 0:r.toDate())||new Date,updatedAt:((i=t.updatedAt)==null?void 0:i.toDate())||new Date}}entityToDoc(e){const{id:t,createdAt:r,updatedAt:i,...c}=e,a={...c};return r instanceof Date&&(a.createdAt=f.fromDate(r)),i instanceof Date&&(a.updatedAt=f.fromDate(i)),a}async getAll(){try{s.debug(`[FirebaseRepo] Fetching all from collection: ${this.collectionName}`);const e=E(u,this.collectionName),t=await y(e);s.debug(`[FirebaseRepo] Found ${t.docs.length} documents in ${this.collectionName}`);const r=t.docs.map(i=>this.docToEntity(i.id,i.data()));return s.debug(`[FirebaseRepo] Mapped ${r.length} results for ${this.collectionName}`),r}catch(e){throw s.error(`Error fetching all from ${this.collectionName}:`,e),h.operationFailed(`fetch all ${this.collectionName}`,e instanceof Error?e:void 0)}}async getById(e){try{const t=g(u,this.collectionName,e),r=await p(t);return r.exists()?this.docToEntity(r.id,r.data()):null}catch(t){throw s.error(`Error fetching document ${e} from ${this.collectionName}:`,t),h.operationFailed(`fetch ${this.collectionName} by ID`,t instanceof Error?t:void 0)}}async create(e){try{const t=f.now(),r={...this.entityToDoc(e),createdAt:t,updatedAt:t},i=E(u,this.collectionName),c=await w(i,r),a=await p(c);return this.docToEntity(a.id,a.data())}catch(t){throw s.error(`Error creating document in ${this.collectionName}:`,t),h.operationFailed(`create ${this.collectionName}`,t instanceof Error?t:void 0)}}async update(e,t){try{const r=g(u,this.collectionName,e);if(!(await p(r)).exists())throw h.notFound(this.collectionName,e);const c={...this.entityToDoc(t),updatedAt:f.now()};await v(r,c);const a=await p(r);return this.docToEntity(a.id,a.data())}catch(r){throw r instanceof l?r:(s.error(`Error updating document ${e} in ${this.collectionName}:`,r),h.operationFailed(`update ${this.collectionName}`,r instanceof Error?r:void 0))}}async delete(e){try{const t=g(u,this.collectionName,e);await R(t)}catch(t){throw s.error(`Error deleting document ${e} from ${this.collectionName}:`,t),h.operationFailed(`delete ${this.collectionName}`,t instanceof Error?t:void 0)}}async bulkDelete(e){try{for(let r=0;r<e.length;r+=500){const i=$(u);e.slice(r,r+500).forEach(a=>{const n=g(u,this.collectionName,a);i.delete(n)}),await i.commit()}}catch(t){throw s.error(`Error bulk deleting from ${this.collectionName}:`,t),h.operationFailed(`bulk delete ${this.collectionName}`,t instanceof Error?t:void 0)}}async search(e){try{let r=await this.getAll();if(e.query&&e.fields.length>0){const i=e.query.toLowerCase();r=r.filter(c=>e.fields.some(a=>{const n=c[a];return n==null?!1:String(n).toLowerCase().includes(i)}))}return e.filters&&e.filters.length>0&&(r=r.filter(i=>e.filters.every(c=>{const a=i[c.field];if(a==null)return!1;const n=String(a).toLowerCase(),m=String(c.value).toLowerCase();switch(c.operator){case"equals":return n===m;case"contains":return n.includes(m);case"startsWith":return n.startsWith(m);case"endsWith":return n.endsWith(m);case"gt":return Number(a)>Number(c.value);case"lt":return Number(a)<Number(c.value);default:return!1}}))),r}catch(t){throw t instanceof l?t:(s.error(`Error searching in ${this.collectionName}:`,t),h.operationFailed(`search ${this.collectionName}`,t instanceof Error?t:void 0))}}subscribe(e,t){s.debug(`[FirebaseRepo] Setting up real-time listener for: ${this.collectionName}`);const r=E(u,this.collectionName),i=D(r,c=>{s.debug(`[FirebaseRepo] Real-time update for ${this.collectionName}: ${c.docs.length} documents`);const a=c.docs.map(n=>this.docToEntity(n.id,n.data()));e(a)},c=>{s.error(`[FirebaseRepo] Real-time listener error for ${this.collectionName}:`,c),t(c)});return()=>{s.debug(`[FirebaseRepo] Unsubscribing from ${this.collectionName}`),i()}}}class F{static createCollectionRepository(e){return new T(e)}}const S=o=>F.createCollectionRepository(o);export{l as D,S as c};
